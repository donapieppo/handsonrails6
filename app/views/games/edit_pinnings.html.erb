<div class="container">
<h1><%= @game.name %></h1>

<% width  = @game.image.metadata[:width] %>  
<% height = @game.image.metadata[:height] %>  

<script type="module">
  import { Hold, HoldPinner } from '../../sketch/holds_pinning_lib.konvajs.js';

  var hold_pinner = new HoldPinner('canvasDiv', <%= width %>, <%= height %>);

   const startingHolds = <%= raw (@game.pinnings ? @game.pinnings.to_json : []) %>;

   hold_pinner.setup(startingHolds);

   document.querySelector('#start_hold_btn').addEventListener('click', start_hold)
   document.querySelector('#top_hold_btn').addEventListener('click', top_hold)
   document.querySelector('#common_hold_btn').addEventListener('click', common_hold)
   document.querySelector('#save_btn').addEventListener('click', save_holds)

   function start_hold() {
     hold_pinner.change_hold_type('start');
   }
   function top_hold() {
     hold_pinner.change_hold_type('top');
   }
   function common_hold() {
     hold_pinner.change_hold_type('hold');
   }
   function save_holds() {
     var result = hold_pinner.get_holds();
     console.log(JSON.stringify(result));
     let myRequest = new Request('<%= pinnings_game_path(@game) %>', 
       { 
         method: 'POST', 
         headers: { "Content-Type": "application/json" },
         body: JSON.stringify(result)
       }
     );
     fetch(myRequest).then(function(response) {
       console.log(response);
       if (response.statusText === 'OK') {
         window.location.href = "<%= game_path(@game) %>";
       };
     });
   }
</script>
<div style="position: fixed; top: 0; left: 0; text-align: center; width: 100%; z-index: 1000">
  <button id="start_hold_btn" class="brn btn-primary">PRESA/E DI PARTENZA</button>
  <button id="common_hold_btn" class="brn btn-primary">ALTRE PRESE</button>
  <button id="top_hold_btn" class="brn btn-primary">TOP</button>
  <button id="save_btn" class="brn btn-primary">SALVA</button>
</div>
<div id="canvasDiv" style="width: <%= width %>px; height: <%= height %>px; background-image: url('<%= url_for(@game.image) %>')"></div>
<%# document.write('<img src="'+img+'"/>'); %>
</div><!-- container -->
